name: Oracle DB Automation CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest

    services:
      oracle:
        image: gvenzl/oracle-free
        ports:
          - 1521:1521
        env:
          ORACLE_PASSWORD: Oracle123
        options: >-
          --health-cmd="healthcheck.sh"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=10

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: "17"
        distribution: "temurin"

    - name: Wait for Oracle DB to be ready
      run: |
        echo "Waiting for Oracle DB to start..."
        for i in {1..30}; do
          nc -z localhost 1521 && echo "Oracle is up!" && break
          echo "Waiting..."
          sleep 10
        done

    - name: Install SQL*Plus (Oracle Instant Client)
      run: |
        sudo apt-get update
        sudo apt-get install -y libaio1 unzip
        wget https://download.oracle.com/otn_software/linux/instantclient/236000/instantclient-basiclite-linux.x64-23.6.zip
        unzip instantclient-basiclite-linux.x64-23.6.zip
        sudo mv instantclient* /opt/oracle
        export LD_LIBRARY_PATH=/opt/oracle
        echo "Instant Client Installed"

    - name: Create AUTOMATION user + table in Oracle
      run: |
        sudo apt-get install -y sqlplus
        echo "ALTER SESSION SET CONTAINER = FREEPDB1;
              CREATE USER AUTOMATION IDENTIFIED BY \"Auto@123\";
              GRANT CREATE SESSION, CONNECT, RESOURCE, UNLIMITED TABLESPACE TO AUTOMATION;
              CREATE TABLE AUTOMATION.USERS (
                ID NUMBER PRIMARY KEY,
                USERNAME VARCHAR2(50),
                ROLE VARCHAR2(50)
              );
              " > setup.sql
        docker exec oracle-free bash -c "cat /workspace/setup.sql | sqlplus sys/Oracle123@localhost:1521/FREEPDB1 as sysdba"

    - name: Build and run Maven tests
      run: mvn -B clean test

    - name: Upload Extent Report & Logs
      uses: actions/upload-artifact@v3
      with:
        name: test-reports
        path: |
          logs/**/*.log
          logs/**/*.html
